<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>2&nbsp; To use this notebook – An Introduction to Single Cell RNAseq with Seurat</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./index.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-5d514503d8eee97d106f576489999bcc.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./Intro.html"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">To use this notebook</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">An Introduction to Single Cell RNAseq with Seurat</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Intro.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">To use this notebook</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction-to-scrna-seq" id="toc-introduction-to-scrna-seq" class="nav-link active" data-scroll-target="#introduction-to-scrna-seq"><span class="header-section-number">2.1</span> Introduction to scRNA-seq</a></li>
  <li><a href="#seurat-objects-overview" id="toc-seurat-objects-overview" class="nav-link" data-scroll-target="#seurat-objects-overview"><span class="header-section-number">2.2</span> Seurat objects overview</a></li>
  <li><a href="#importing-data-and-interacting-with-seurat-objects" id="toc-importing-data-and-interacting-with-seurat-objects" class="nav-link" data-scroll-target="#importing-data-and-interacting-with-seurat-objects"><span class="header-section-number">2.3</span> Importing data and interacting with Seurat objects</a></li>
  <li><a href="#data-qc" id="toc-data-qc" class="nav-link" data-scroll-target="#data-qc"><span class="header-section-number">2.4</span> Data QC</a></li>
  <li><a href="#data-filtering" id="toc-data-filtering" class="nav-link" data-scroll-target="#data-filtering"><span class="header-section-number">2.5</span> Data Filtering</a></li>
  <li><a href="#normalization" id="toc-normalization" class="nav-link" data-scroll-target="#normalization"><span class="header-section-number">2.6</span> Normalization</a>
  <ul class="collapse">
  <li><a href="#theory" id="toc-theory" class="nav-link" data-scroll-target="#theory"><span class="header-section-number">2.6.1</span> Theory</a></li>
  <li><a href="#when-should-you-not-use-sctransform" id="toc-when-should-you-not-use-sctransform" class="nav-link" data-scroll-target="#when-should-you-not-use-sctransform"><span class="header-section-number">2.6.2</span> When should you not use SCTransform?</a></li>
  <li><a href="#sctransform-versions" id="toc-sctransform-versions" class="nav-link" data-scroll-target="#sctransform-versions"><span class="header-section-number">2.6.3</span> SCTransform versions</a></li>
  <li><a href="#running-sctransform" id="toc-running-sctransform" class="nav-link" data-scroll-target="#running-sctransform"><span class="header-section-number">2.6.4</span> Running SCTransform</a></li>
  </ul></li>
  <li><a href="#integration" id="toc-integration" class="nav-link" data-scroll-target="#integration"><span class="header-section-number">2.7</span> Integration</a>
  <ul class="collapse">
  <li><a href="#canonical-correlation-analysis-cca-integration" id="toc-canonical-correlation-analysis-cca-integration" class="nav-link" data-scroll-target="#canonical-correlation-analysis-cca-integration"><span class="header-section-number">2.7.1</span> Canonical Correlation Analysis (CCA) Integration</a></li>
  <li><a href="#reciprocal-principal-components-analysis-rpca-integration" id="toc-reciprocal-principal-components-analysis-rpca-integration" class="nav-link" data-scroll-target="#reciprocal-principal-components-analysis-rpca-integration"><span class="header-section-number">2.7.2</span> Reciprocal Principal Components Analysis (RPCA) Integration</a></li>
  <li><a href="#jointpca-integration" id="toc-jointpca-integration" class="nav-link" data-scroll-target="#jointpca-integration"><span class="header-section-number">2.7.3</span> JointPCA Integration</a></li>
  <li><a href="#harmony-integration" id="toc-harmony-integration" class="nav-link" data-scroll-target="#harmony-integration"><span class="header-section-number">2.7.4</span> Harmony Integration</a></li>
  </ul></li>
  <li><a href="#clustering" id="toc-clustering" class="nav-link" data-scroll-target="#clustering"><span class="header-section-number">2.8</span> Clustering</a>
  <ul class="collapse">
  <li><a href="#clustering-resolution-selection" id="toc-clustering-resolution-selection" class="nav-link" data-scroll-target="#clustering-resolution-selection"><span class="header-section-number">2.8.1</span> Clustering resolution selection</a></li>
  </ul></li>
  <li><a href="#differential-expression-analysis" id="toc-differential-expression-analysis" class="nav-link" data-scroll-target="#differential-expression-analysis"><span class="header-section-number">2.9</span> Differential Expression Analysis</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="header-section-number">2.10</span> Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">To use this notebook</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<ol type="1">
<li>Go to ood.ccv.brown.edu (you will need an Oscar account).</li>
<li>Go to ‘Clusters’ in the blue menu bar at the top and click the drop-down that says ‘&gt;_OSCAR Shell Access’</li>
<li>Go to your home folder and type <code>git clone https://github.com/compbiocore/intro_scrna_dscov.git</code></li>
<li>Look under <code>Interactive Apps</code> in the blue menu bar and click on <code>RStudio on Singularity</code> under <code>Expert GUIs</code>. Fill in the fields as follows:</li>
</ol>
<ul>
<li><code>Account</code>: leave blank<br>
</li>
<li><code>Partition</code>: leave blank<br>
</li>
<li><code>Number of hours</code>: 2<br>
</li>
<li><code>Num Cores</code>: 1<br>
</li>
<li><code>Memory</code>: 100<br>
</li>
<li><code>Singularity Container Path</code> : <code>/oscar/data/shared/databases/workshops/dscov/intro_scrna_dscov/metadata/intro_scrna_dscov.sif</code><br>
</li>
<li><code>Path for rsession executable</code>: leave blank<br>
</li>
<li><code>Package install Path</code>: leave blank<br>
</li>
<li><code>R Module</code>: leave blank<br>
</li>
<li><code>Additional Data Path</code>: leave blank<br>
</li>
</ul>
<ol start="5" type="1">
<li>Once your job starts, click the button to connect to session.<br>
</li>
<li>At the top of the screen you’ll see a menu bar that starts with ‘file’, click on ‘file’ and ‘open file’.<br>
</li>
<li>Go to your home folder where you have cloned this repository and open up <code>notebooks/Intro.qmd</code>: `</li>
</ol>
<section id="introduction-to-scrna-seq" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="introduction-to-scrna-seq"><span class="header-section-number">2.1</span> Introduction to scRNA-seq</h2>
<p><strong>What we will cover</strong><br>
* Seurat objects and importing data<br>
* Data QC and filtering<br>
* SCTransform normalization, clustering, dimension reduction<br>
* Data integration<br>
* Differential expression<br>
* Data visualization<br>
</p>
<p>Much of this notebook is adapted from the Seurat vignettes https://satijalab.org/seurat, GitHub repository https://github.com/satijalab/seurat, and this wiki for comparison of integration methods: https://deepwiki.com/satijalab/seurat</p>
</section>
<section id="seurat-objects-overview" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="seurat-objects-overview"><span class="header-section-number">2.2</span> Seurat objects overview</h2>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>In November of 2023, Seurat made a major upgrade to Seurat v5 (https://github.com/satijalab/seurat/releases), which included many new functions and other changes (https://satijalab.org/seurat/articles/announcements.html#changes-in-seurat-v5), including some very big changes to the default behavior of Seurat. <strong>You will likely see different results depending on which version of Seurat you have used for your analysis.</strong> Feel free to come to our office hours if you want help setting up reproducible analyses using either version of Seurat.</p>
</div>
</div>
<p>This workshop focuses on using Seurat objects to structure your scRNA-seq data (https://github.com/satijalab/seurat/wiki/Seurat), we will attempt to cover how to interact with Seurat objects in Seurat v4 and v5, but won’t exhaustively cover the differences between the two versions.</p>
<p>Let’s get started. First, we can set the <code>.libPaths()</code>, which essentially tells R that it should look for packages inside these locations inside the Singularity container.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">.libPaths</span>(<span class="fu">c</span>(<span class="st">'/usr/local/lib/R/site-library'</span>, <span class="st">'/usr/local/lib/R/library'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ll also set a seed at the start of the notebook so that we can reproduce our results if we decide to re-run this notebook at some future date. We also set <code>future.globals.maxSize</code>, see the Seurat future vignette linked above for discussion about why we do this (basically we might be exceeding the allowed global variable size so we make that default bigger).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">61</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">future.globals.maxSize =</span> <span class="dv">4000</span> <span class="sc">*</span> <span class="dv">1024</span><span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, load all the libraries we need, including some Seurat data packages. The last lines will update the Seurat objects so that they are compatible with the newest version of Seurat.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RColorBrewer)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Seurat)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(hdf5r)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(biomaRt)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SeuratDisk)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SeuratData)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(msigdbr)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(clustree)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'ifnb.SeuratData'</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'pbmc3k.SeuratData'</span>)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"ifnb"</span>)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"pbmc3k"</span>)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>ifnb <span class="ot">&lt;-</span> <span class="fu">UpdateSeuratObject</span>(ifnb)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>pbmc3k <span class="ot">&lt;-</span> <span class="fu">UpdateSeuratObject</span>(pbmc3k)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here’s a schematic of a Seurat object:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="image/seurat_object.png" width="470" height="400" class="figure-img"></p>
<figcaption>Schematic of a Seurat object</figcaption>
</figure>
</div>
<ul>
<li>Each Seurat object is composed of different components:
<ul>
<li><strong><code>assays</code></strong> is a list of all the assays in the object.
<ul>
<li><p>Defaults to <code>RNA</code> assay, but you can add others (like <code>SCT</code> for normalized counts, shown in the figure above, could also be antibody-derived tags, etc.).</p></li>
<li><p>You can see all assays using <code>Assays(ifnb)</code>, see which assay is the currently active assay by looking in the <code>active.assay</code> slot (<code>ifnb@active.assay</code>) and switch between them using the <code>DefaultAssay()</code> function (<code>DefaultAssay(ifnb) &lt;- 'RNA'</code>).</p></li>
<li><p>Each assay will store multiple transformations of the data in different <code>slots</code> (or <code>layers</code> in Seurat v5) – in the case of <code>RNA</code> data these slots are:</p>
<ul>
<li><code>@counts</code> contains the raw counts.</li>
<li><code>@data</code> contains the normalized counts.</li>
<li><code>@scale.data</code> contains the scaled data for dimensional reduction.</li>
</ul></li>
<li><p>The <code>slots</code> (Seurat v4) or <code>layers</code> (Seurat v5) store the data as a sparse matrix where the rows are gene and the columns are cells.</p></li>
<li><p>In Seurat v4, you could access the raw counts like this:<code>GetAssayData(ifnb, assay='RNA', slot='counts')</code>. This will still work in Seurat v5, but you’ll get a warning message. In Seurat v5 it is intended that you access the counts using the <code>LayerData</code> function, like this: <code>LayerData(ifnb, assay='RNA', layer='counts')</code></p></li>
<li><p>In either version of Seurat <code>ifnb[['RNA']]$counts</code> will also work.</p></li>
</ul></li>
<li><strong><code>meta.data</code></strong> is a matrix of all the cell-level metadata.
<ul>
<li>This will include information about which condition, timepoint, batch, etc. a for a given cell.</li>
<li>It also includes metrics that will be relevant for QC, like <code>nCount_RNA</code> and <code>nFeature_RNA</code>
<ul>
<li><code>nCount_RNA</code> is the total number of molecules (UMIs) detected within a cell.</li>
<li><code>nFeature_RNA</code> is the total number of genes detected within a cell.</li>
</ul></li>
<li>Once you have completed clustering, you’ll also see information about which cluster each cell has been assigned to.</li>
<li>The different categories or columns in the <code>meta.data</code> are also called <code>Idents</code> in Seurat.</li>
<li>You can see the current <code>Ident</code> in the <code>active.ident</code> slot (<code>ifnb@active.ident</code>) and switch between them using the <code>Idents()</code> function (this will probably be important for running differential expression testing).</li>
<li>You can use <code>table(Idents(ifnb))</code> for a quick summary of the number of cells in each grouping.</li>
</ul></li>
<li><strong><code>graphs</code></strong> is a list of the nearest neighbor graphs.
<ul>
<li>The objects stored in <code>graphs</code> are cell x cell matrices containing the neighborhood overlap (Jaccard index) between every cell and its nearest neighbors.</li>
</ul></li>
<li><strong><code>reductions</code></strong> is a list of <code>DimReduc</code> objects.</li>
<li><strong><code>version</code></strong> contains information about which version of Seurat was used to make the object.</li>
<li>There are other optional slots, including <strong><code>tools</code></strong> and <strong><code>misc</code></strong> that can be populated by specific analysis tools (<code>tools</code>) or users can store their own additional information (<code>misc</code>).</li>
</ul></li>
</ul>
</section>
<section id="importing-data-and-interacting-with-seurat-objects" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="importing-data-and-interacting-with-seurat-objects"><span class="header-section-number">2.3</span> Importing data and interacting with Seurat objects</h2>
<p>We are using the <code>SeuratData</code> package for some test data, which is already installed in this container.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>SeuratData<span class="sc">::</span><span class="fu">AvailableData</span>() <span class="sc">%&gt;%</span> <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(Installed <span class="sc">==</span> <span class="st">'TRUE'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                  Dataset Version                           Summary species
ifnb.SeuratData      ifnb   3.1.0 IFNB-Stimulated and Control PBMCs   human
pbmc3k.SeuratData  pbmc3k   3.1.4        3k PBMCs from 10X Genomics   human
                  system ncells   tech seurat default.dataset disk.datasets
ifnb.SeuratData     PBMC  13999 10x v1   &lt;NA&gt;             raw          &lt;NA&gt;
pbmc3k.SeuratData   PBMC   2700 10x v1  3.1.4             raw          &lt;NA&gt;
                  other.datasets notes Installed InstalledVersion
ifnb.SeuratData        processed  &lt;NA&gt;      TRUE            3.1.0
pbmc3k.SeuratData   pbmc3k.final  &lt;NA&gt;      TRUE            3.1.4</code></pre>
</div>
</div>
<p>It is more likely that you are using Seurat with your own data – you can use the functions <code>Read10X</code> or <code>Read10X_h5</code> to import data. <code>Read10X_h5</code> works with H5 files – “Hierarchical Data Format (HDF5 or H5). H5 is a binary format that can compress and access data much more efficiently than text formats such as MEX, which is especially useful when dealing with large datasets.” https://support.10xgenomics.com/single-cell-gene-expression/software/pipelines/latest/advanced/h5_matrices. You can also use <code>Read10X</code> and give a path to a folder that contains your matrix, features, and barcode tsv files. After you have read in the 10X data, use it as the input to the <code>CreateSeuratObject</code> function.</p>
<p>We can look at the Seurat object we’ve loaded from SeuratData:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>?ifnb</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>ifnb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>An object of class Seurat 
14053 features across 13999 samples within 1 assay 
Active assay: RNA (14053 features, 0 variable features)
 2 layers present: counts, data</code></pre>
</div>
</div>
<p>The <code>ifnb</code> dataset is 14,000 IFNB-Stimulated and Control PBMCs (peripheral blood mononuclear cells).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>?pbmc3k</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>pbmc3k</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>An object of class Seurat 
13714 features across 2700 samples within 1 assay 
Active assay: RNA (13714 features, 0 variable features)
 2 layers present: counts, data</code></pre>
</div>
</div>
<p>The <code>pbmc3k</code> dataset is 2,700 PBMCs (peripheral blood mononuclear cells).</p>
<p>We can also see that Seurat v5 assays store data in layers. These layers can store raw, un-normalized counts (layer=‘counts’), normalized data (layer=‘data’) or z-scored/variance-stabilized data (layer=‘scale.data’). What assays and meta.data are available?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>ifnb<span class="sc">@</span>assays</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$RNA
Assay data with 14053 features for 13999 cells
First 10 features:
 AL627309.1, RP11-206L10.2, LINC00115, NOC2L, KLHL17, PLEKHN1, HES4,
ISG15, AGRN, C1orf159 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(ifnb<span class="sc">@</span>meta.data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                  orig.ident nCount_RNA nFeature_RNA stim seurat_annotations
AAACATACATTTCC.1 IMMUNE_CTRL       3017          877 CTRL          CD14 Mono
AAACATACCAGAAA.1 IMMUNE_CTRL       2481          713 CTRL          CD14 Mono
AAACATACCTCGCT.1 IMMUNE_CTRL       3420          850 CTRL          CD14 Mono
AAACATACCTGGTA.1 IMMUNE_CTRL       3156         1109 CTRL                pDC
AAACATACGATGAA.1 IMMUNE_CTRL       1868          634 CTRL       CD4 Memory T
AAACATACGGCATT.1 IMMUNE_CTRL       1581          557 CTRL          CD14 Mono</code></pre>
</div>
</div>
<p>We have an <code>RNA</code> assay, and metadata contains information about which experimental condition the cell came from (<code>orig.ident</code> and <code>stim</code>), the number of genes (<code>nFeature_RNA</code>) and molecules (<code>nCount_RNA</code>) in each cell. This particular object also comes pre-annotated (<code>seurat_annotations</code>).</p>
<p>If we look at the unique values in <code>orig.ident</code>, we see that there’s <code>IMMUNE_CTRL</code> and <code>IMMUNE_STIM</code> samples in one Seurat object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(ifnb<span class="sc">@</span>meta.data<span class="sc">$</span>orig.ident)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
IMMUNE_CTRL IMMUNE_STIM 
       6548        7451 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>pbmc3k<span class="sc">@</span>assays</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$RNA
Assay data with 13714 features for 2700 cells
First 10 features:
 AL627309.1, AP006222.2, RP11-206L10.2, RP11-206L10.9, LINC00115, NOC2L,
KLHL17, PLEKHN1, RP11-54O7.17, HES4 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(pbmc3k<span class="sc">@</span>meta.data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               orig.ident nCount_RNA nFeature_RNA seurat_annotations
AAACATACAACCAC     pbmc3k       2419          779       Memory CD4 T
AAACATTGAGCTAC     pbmc3k       4903         1352                  B
AAACATTGATCAGC     pbmc3k       3147         1129       Memory CD4 T
AAACCGTGCTTCCG     pbmc3k       2639          960         CD14+ Mono
AAACCGTGTATGCG     pbmc3k        980          521                 NK
AAACGCACTGGTAC     pbmc3k       2163          781       Memory CD4 T</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(pbmc3k<span class="sc">@</span>meta.data<span class="sc">$</span>orig.ident)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
pbmc3k 
  2700 </code></pre>
</div>
</div>
<p>If we look at the unique values in <code>orig.ident</code> for the <code>pbmc3k</code> object, we see that there’s only <code>pbmc3k</code> samples.</p>
</section>
<section id="data-qc" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="data-qc"><span class="header-section-number">2.4</span> Data QC</h2>
<p>First, lets subset our datasets so they are smaller and easier to work with for this workshop.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>pbmc3k <span class="ot">&lt;-</span> <span class="fu">subset</span>(pbmc3k, <span class="at">downsample =</span> <span class="dv">500</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>ifnb <span class="ot">&lt;-</span> <span class="fu">subset</span>(ifnb, <span class="at">downsample =</span> <span class="dv">500</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>For now, let’s merge the datasets to make our QC and filtering a bit smoother.</li>
<li><code>merge()</code> merges the raw count matrices of two Seurat objects and creates a new Seurat object with the resulting combined raw count matrix.</li>
<li>To explicitly specify the original object any particular cell came from, you can set the <code>add.cell.ids</code> parameter with an c(x, y) vector, which will prepend the given identifier to the beginning of each cell name.</li>
<li>The original project ID will remain stored in object meta data under <code>orig.ident</code>.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>all_data <span class="ot">&lt;-</span> <span class="fu">merge</span>(<span class="at">x =</span> ifnb, <span class="at">y =</span> pbmc3k, <span class="at">add.cell.ids =</span> <span class="fu">c</span>(<span class="st">"ifnb"</span>, <span class="st">"pbmc3k"</span>), <span class="at">project =</span> <span class="st">'pbmc'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>We care about the percentage of reads that map to the mitochondrial genome because high mitochondrial reads in a cell can indicate that the cells are low-quality or dying cells</li>
<li>The mitochondrial QC metrics are calcualted with the <code>PercentageFeatureSet()</code> function, which calculates the percentage of counts originating from a set of features</li>
<li>We use the set of all genes starting with MT- as a set of mitochondrial genes – the format of the mt sequences will vary depending on which organism/genome is used…(might be ‘mt-’ for example).</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(all_data) <span class="sc">%&gt;%</span> <span class="fu">grep</span>(<span class="at">pattern =</span> <span class="st">'^mt-'</span>, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "MT-ND1"  "MT-ND2"  "MT-CO1"  "MT-CO2"  "MT-ATP8" "MT-ATP6" "MT-CO3" 
 [8] "MT-ND3"  "MT-ND4L" "MT-ND4"  "MT-ND5"  "MT-ND6"  "MT-CYB" </code></pre>
</div>
</div>
<ul>
<li>Then add the percent mitochondrial reads to the metadata:</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>all_data[[<span class="st">"percent.mt"</span>]] <span class="ot">&lt;-</span> <span class="fu">PercentageFeatureSet</span>(all_data, <span class="at">pattern =</span> <span class="st">"^MT-"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Before we plot, we can set the order of the object idents to whatever order we’d like:</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(all_data) <span class="ot">&lt;-</span> <span class="st">'orig.ident'</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">levels</span>(all_data) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"pbmc3k"</span>, <span class="st">"IMMUNE_CTRL"</span>, <span class="st">"IMMUNE_STIM"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>We can also look at plots showing the distribution of the <code>percent.mt</code>, <code>nFeature_RNA</code> and <code>nCount_RNA</code></li>
<li><code>nFeature_RNA</code> is the number of genes</li>
<li><code>nCount_RNA</code> is the number of UMIs (unique molecules – like counts)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">VlnPlot</span>(all_data, <span class="at">features =</span> <span class="st">"nFeature_RNA"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Intro_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">VlnPlot</span>(all_data, <span class="at">features =</span> <span class="st">"nCount_RNA"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Intro_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">VlnPlot</span>(all_data, <span class="at">features=</span><span class="st">"percent.mt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Intro_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">FeatureScatter</span>(all_data, <span class="at">feature1 =</span> <span class="st">"nCount_RNA"</span>, <span class="at">feature2 =</span> <span class="st">"nFeature_RNA"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Intro_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">FeatureScatter</span>(all_data, <span class="at">feature1 =</span> <span class="st">"nCount_RNA"</span>, <span class="at">feature2 =</span> <span class="st">"percent.mt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Intro_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">FeatureScatter</span>(all_data, <span class="at">feature1 =</span> <span class="st">"nFeature_RNA"</span>, <span class="at">feature2 =</span> <span class="st">"percent.mt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Intro_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>You can also just use ggplot to make your own custom visualizations of the information in the metadata. We make a separate matrix called <code>qc_data</code> and sorting it based on the <code>percent.mt</code> column. Then we make our own ggplot and specify that the x and y axes should be <code>nCount_RNA</code> and <code>nFeature_RNA</code> and that the points should be colored based on <code>percent.mt</code>. Then, use <code>scale_color_gradientn</code> to specify how the points should be colored, specifying that the limit should be between 0 and 10 and that we should <code>squish</code> anything that is out of bounds (effectively making our limits 0 and &gt;10).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>qc_data <span class="ot">&lt;-</span> all_data<span class="sc">@</span>meta.data[<span class="fu">c</span>(<span class="st">'orig.ident'</span>,<span class="st">'nCount_RNA'</span>,<span class="st">'nFeature_RNA'</span>,<span class="st">'percent.mt'</span>)] <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(percent.mt)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(qc_data, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> nCount_RNA, <span class="at">y =</span> nFeature_RNA, <span class="at">color =</span> percent.mt)) <span class="sc">+</span> </span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span> <span class="fu">scale_color_gradientn</span>(<span class="at">colors =</span> <span class="fu">rev</span>(<span class="fu">brewer.pal</span>(<span class="dv">5</span>, <span class="st">"Spectral"</span>)), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">10</span>), <span class="at">oob =</span> (scales<span class="sc">::</span>squish)) <span class="sc">+</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>orig.ident) <span class="sc">+</span> </span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Intro_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>Low quality cells or empty droplets might have very few genes (<code>nFeatures</code>)</li>
<li>Dead or dying cells will also have high mitochondrial reads (<code>percent.mt</code>)</li>
<li>Doublets or multiplets will have high gene counts (<code>nFeatures</code>)</li>
<li>The total number of molecules (<code>nCount</code>) detected in a cell corresponds with the number of genes (<code>nFeatures</code>)</li>
<li>Most of the cells have less than 2000 genes and less than 7000 or so UMIs.</li>
<li>Very low mitochondrial counts from the <code>ifnb</code> data and the nFeature_RNA scatter plots look strange – perhaps this dataset was pre-filtered before being packaged into SeuratData.</li>
<li>In the <code>pbmc3k</code> data, we can see groups of cells with high mitochondrial counts, low UMI counts, and lower numbers of genes.</li>
<li>Our goal in QC filtering is to retain as much useful information as we can, while removing doublets, empty droplets, and dead cells.</li>
<li>We will pick some thresholds for filtering based off of what we see in our data, keeping in mind that if you are doing this with your own data, your plots will probably look a bit different.</li>
</ul>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>We don’t get into it in this workshop, but an additional QC consideration is ambient RNA. Look at this document from 10x for more information: https://www.10xgenomics.com/analysis-guides/introduction-to-ambient-rna-correction</p>
</div>
</div>
</section>
<section id="data-filtering" class="level2" data-number="2.5">
<h2 data-number="2.5" class="anchored" data-anchor-id="data-filtering"><span class="header-section-number">2.5</span> Data Filtering</h2>
<ul>
<li>Let’s filter our data using <code>subset</code>, we’ll keep cells that have between 500 and 7000 nFeature_RNA (genes) and less than 5% mitochondrial reads.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>all_data_sub <span class="ot">&lt;-</span> <span class="fu">subset</span>(all_data, <span class="at">subset =</span> nFeature_RNA <span class="sc">&gt;</span> <span class="dv">500</span> <span class="sc">&amp;</span> nFeature_RNA <span class="sc">&lt;</span> <span class="dv">7000</span> <span class="sc">&amp;</span> percent.mt <span class="sc">&lt;</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>You can re-examine your QC plots after filtering if you’d like:</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>qc_data_sub <span class="ot">&lt;-</span> all_data_sub<span class="sc">@</span>meta.data[<span class="fu">c</span>(<span class="st">'orig.ident'</span>,<span class="st">'nCount_RNA'</span>,<span class="st">'nFeature_RNA'</span>,<span class="st">'percent.mt'</span>)] <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(percent.mt)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(qc_data_sub,ggplot2<span class="sc">::</span> <span class="fu">aes</span>(<span class="at">x =</span> nCount_RNA, <span class="at">y =</span> nFeature_RNA, <span class="at">color =</span> percent.mt)) <span class="sc">+</span> </span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_gradientn</span>(<span class="at">colors =</span> <span class="fu">rev</span>(<span class="fu">brewer.pal</span>(<span class="dv">5</span>, <span class="st">"Spectral"</span>)), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">10</span>), <span class="at">oob =</span> (scales<span class="sc">::</span>squish)) <span class="sc">+</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>orig.ident) <span class="sc">+</span> </span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Intro_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>We can also take a look at how many cells we lost from filtering:</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(all_data<span class="sc">@</span>meta.data<span class="sc">$</span>orig.ident)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
IMMUNE_CTRL IMMUNE_STIM      pbmc3k 
        500         500         500 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(all_data_sub<span class="sc">@</span>meta.data<span class="sc">$</span>orig.ident)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
IMMUNE_CTRL IMMUNE_STIM      pbmc3k 
        500         500         456 </code></pre>
</div>
</div>
</section>
<section id="normalization" class="level2" data-number="2.6">
<h2 data-number="2.6" class="anchored" data-anchor-id="normalization"><span class="header-section-number">2.6</span> Normalization</h2>
<section id="theory" class="level3" data-number="2.6.1">
<h3 data-number="2.6.1" class="anchored" data-anchor-id="theory"><span class="header-section-number">2.6.1</span> Theory</h3>
<p>scRNAseq data is normalized so that we can mitigate technical effects while preserving the biological signal in the data – we should be able to find the biological signal in cells irrespective of how deeply we sequenced the cell. The theory behind SCTransform (https://genomebiology.biomedcentral.com/articles/10.1186/s13059-019-1874-1) is very similar to the generalized linear models (GLMs) used in bulk RNAseq analysis packages like DESeq2 and edgeR. In DESeq2 a negative binomial model is fitted to the counts and the mean and dispersion (roughly speaking how variable the observed count will be from the mean count) estimates from that model are used as the test statistics for comparison between group and the same idea applies with SCTransform. SCTransform also pools information across genes with similar abundances in order to address the higher sparsity of single cell data.</p>
<p>Below is a side-by-side comparison of sctransform with NormalizeData, FindVariableFeatures and ScaleData on the PBMC3k data:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="image/sctransform_vs_regular.png" class="img-fluid figure-img"></p>
<figcaption>sct</figcaption>
</figure>
</div>
<p>We also like this figure from the SCTransform paper, which shows how SCTransform (‘Pearson Residuals’) and the standard log-transformation approach (‘Log-normalization’) helps alleviate variance in your data from sequencing depth alone :</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="image/sct_fig6.png" class="img-fluid figure-img"></p>
<figcaption>sct_fig6</figcaption>
</figure>
</div>
</section>
<section id="when-should-you-not-use-sctransform" class="level3" data-number="2.6.2">
<h3 data-number="2.6.2" class="anchored" data-anchor-id="when-should-you-not-use-sctransform"><span class="header-section-number">2.6.2</span> When should you not use SCTransform?</h3>
<p>The paper states:</p>
<p><code>As our workflow leverages all genes (or a random subset) for the initial regularization, we make an implicit assumption that the majority of genes in the dataset do not exhibit significant biological variation...this assumption may be overly simplistic when performing scRNA-seq on a highly heterogeneous sample, we did not observe adverse affects when applying our model to human PBMC data, or any of the other datasets we examined.</code></p>
<p>SCTransform might not work well if your data is highly heterogeneous and you expect that a high proportion of genes will exhibit significant biological variation across your samples. In this case, we would recommend the more standard workflow of <code>NormalizeData</code>, <code>FindVariableFeatures</code>, and <code>ScaleData</code>.</p>
</section>
<section id="sctransform-versions" class="level3" data-number="2.6.3">
<h3 data-number="2.6.3" class="anchored" data-anchor-id="sctransform-versions"><span class="header-section-number">2.6.3</span> SCTransform versions</h3>
<p>Seurat v5 runs SCTransform v2 (https://satijalab.org/seurat/archive/v4.3/sctransform_v2_vignette) by default, while Seurat v4 runs SCTransform v1 by default. SCTransform v2 “improves speed and memory consumption, the stability of parameter estimates, the identification of variable features, and the the ability to perform downstream differential expression analyses.” This means you might get different results if you run Seurat v5 and re-normalize data that you have previously processed with Seurat v4. If you want to change from the default veresion of SCTransform, you can add the argument <code>vst.flavor = "v1"</code> (or <code>vst.flavor = "v2"</code>))</p>
</section>
<section id="running-sctransform" class="level3" data-number="2.6.4">
<h3 data-number="2.6.4" class="anchored" data-anchor-id="running-sctransform"><span class="header-section-number">2.6.4</span> Running SCTransform</h3>
<p>We will normalize using SCTransform and you might get see a warning that says ‘iteration limit reached’ when you run the function. This warning can be ignored (https://github.com/satijalab/sctransform/issues/25) because the parameter estimation generating this warning is regularized later anyway. You can use the <code>vars.to.regress</code> argument to regress out nuisance variables (like cell cycle, batch effects, or <code>percent.mt</code>). By default SCTransform will only return data for variable genes in the scale data slot – adding the <code>return.only.var.genes = FALSE</code> argument to the function call to turn this option off (https://github.com/satijalab/seurat/issues/3553). In previous versions of Seurat, you would have to split your object into a list of Seurat objects based on the <code>orig.ident</code> and then run <code>SCTransform</code> on the list, which is not necessary in Seurat v5 – but we do have to split the layers by their <code>orig.ident</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>all_data_sub[[<span class="st">"RNA"</span>]] <span class="ot">&lt;-</span> <span class="fu">split</span>(all_data_sub[[<span class="st">"RNA"</span>]], <span class="at">f =</span> all_data_sub<span class="sc">$</span>orig.ident)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Input is a v3 assay and `split()` only works for v5 assays; converting
• to a v5 assay</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Assay RNA changing from Assay to Assay5</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>start.time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>all_data_sub <span class="ot">&lt;-</span> <span class="fu">SCTransform</span>(all_data_sub, <span class="at">vars.to.regress =</span> <span class="st">"percent.mt"</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>end.time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>end.time <span class="sc">-</span> start.time</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Time difference of 19.10482 secs</code></pre>
</div>
</div>
<p>Then run PCA</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>all_data_sub <span class="ot">&lt;-</span> <span class="fu">RunPCA</span>(all_data_sub)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>PC_ 1 
Positive:  FTL, TIMP1, FTH1, LYZ, TYROBP, CST3, FCER1G, S100A9, SOD2, LGALS1 
       S100A8, APOBEC3A, S100A4, HLA-DRA, LGALS3, FCN1, TYMP, S100A11, IFITM3, SAT1 
       AIF1, S100A6, ANXA5, CD63, CTSB, HLA-DRB1, LST1, PSAP, IL8, NPC2 
Negative:  RPL3, RPS6, RPS18, LTB, RPL13, RPL13A, RPL21, RPS27A, RPS3A, RPS3 
       RPS27, RPL34, GIMAP7, RPL7, MALAT1, CD3D, RPS15A, CCR7, RPS4X, RPS2 
       LDHB, RPS14, RPS12, RPL9, RPL32, RPL10, RPL23A, RPL31, RPSA, RPS5 
PC_ 2 
Positive:  NKG7, CCL5, GZMB, GNLY, PRF1, CST7, GZMA, CTSW, FGFBP2, GZMH 
       CCL4, CLIC3, FCGR3A, APOBEC3G, KLRD1, CD247, GZMM, B2M, CHST12, HOPX 
       UBB, C1orf21, AKR1C3, APMAP, IGFBP7, CD7, RARRES3, ACTB, SRGN, C12orf75 
Negative:  RPL13, RPS18, RPL13A, RPL32, HLA-DRA, RPS2, RPL10, RPL3, RPS12, RPL34 
       LTB, RPS6, RPS14, RPS4X, RPL18A, RPS3A, RPS5, RPL11, CD74, RPL7 
       RPL10A, RPS15A, CCR7, RPS27, RPL19, RPS13, RPS8, RPL21, RPL12, RPS27A 
PC_ 3 
Positive:  CD3D, GIMAP7, IL32, CD7, SOD2, CD3E, GIMAP5, CD2, CCL5, IL7R 
       LCK, GIMAP4, LDHB, RPL34, RARRES3, TIMP1, ANXA1, CTSL, CD3G, APOBEC3A 
       RPS14, LAT, RPS12, ZFP36L2, NKG7, RPL3, PABPC1, IFI27, RPS3, LTB 
Negative:  CD74, HLA-DRA, HLA-DQA1, HLA-DPB1, HLA-DRB1, HLA-DPA1, HLA-DQB1, CD79A, HERPUD1, MS4A1 
       HLA-DMA, CD83, HLA-DRB5, IRF8, CD79B, PMAIP1, REL, HSP90AB1, BIRC3, SYNGR2 
       HSPD1, CST3, CCR7, PRMT1, ID3, RAN, RPL22L1, LYZ, CYCS, BLNK 
PC_ 4 
Positive:  S100A9, S100A8, LYZ, FTH1, FTL, FCN1, TYROBP, AIF1, CST3, S100A4 
       S100A6, LST1, LGALS2, COTL1, CACYBP, CD14, OAZ1, SRSF2, LGALS1, NOP58 
       SOD1, GIMAP7, CREM, GPX1, DDIT4, YPEL5, SAT1, TRAT1, SRSF7, CFD 
Negative:  CD74, HLA-DRA, HLA-DPB1, CD79A, HLA-DQA1, HLA-DPA1, NKG7, HLA-DQB1, CCL5, HLA-DRB1 
       CST7, CCL4, CD79B, MS4A1, GNLY, TXN, GZMB, CTSW, TIMP1, SOD2 
       ISG20, GZMA, FGFBP2, PTPRCAP, GZMH, HLA-DMA, B2M, APOBEC3G, PRF1, SLAMF7 
PC_ 5 
Positive:  SOD2, JUNB, HSPB1, HSPA1A, CD69, JUN, SRSF7, NFKBIA, CCL4, APOBEC3A 
       CACYBP, DDIT4, TIMP1, SRSF2, HSPA8, CTSL, HSP90AB1, CLK1, TXN, HSPH1 
       DNAJB1, NOP58, HSP90AA1, CREM, YPEL5, IL1RN, EIF5, DNAJB6, ZFAND2A, TSC22D3 
Negative:  CST3, LYZ, S100A9, S100A8, NKG7, TYROBP, GSTP1, AIF1, GNLY, GZMB 
       LGALS2, LST1, FCN1, S100A6, LGALS1, COTL1, FTH1, CCL5, PYCARD, CEBPD 
       CST7, TMSB4X, ALOX5AP, RPS2, TKT, PRF1, CTSS, RPL3, AP1S2, FGFBP2 </code></pre>
</div>
</div>
<p>We can make an elbow plot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ElbowPlot</span>(all_data_sub)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Intro_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Based on this plot, we get diminishing information returned once we get above ~10-15 PCs. We will use this information when we run clustering.</p>
</section>
</section>
<section id="integration" class="level2" data-number="2.7">
<h2 data-number="2.7" class="anchored" data-anchor-id="integration"><span class="header-section-number">2.7</span> Integration</h2>
<p>Integration of single-cell sequencing datasets, for example across experimental batches, donors, or conditions, is often an important step in scRNA-seq workflows. Integrative analysis can help to match shared cell types and states across datasets, which can boost statistical power, and most importantly, facilitate accurate comparative analysis across datasets.</p>
<p>While the goal of matching shared cell types across datasets may be important for many problems, users may also be concerned about which method to use, or that integration could result in a loss of biological resolution. In Seurat v5, we introduce more flexible and streamlined infrastructure to run different integration algorithms with a single line of code. This makes it easier to explore the results of different integration methods, and to compare these results to a workflow that excludes integration steps.</p>
<p>Seurat v5 enables streamlined integrative analysis using the <code>IntegrateLayers</code> function. The method currently supports four integration methods by default. Each of these methods performs integration in low-dimensional space, and returns a dimensional reduction (i.e.&nbsp;integrated.rpca) that aims to co-embed shared cell types across batches (samples). These integration methods can be divided into two categories:</p>
<p>Anchor-based methods: CCA, RPCA, and JointPCA, which rely on identifying pairs of cells (anchors) that are mutual nearest neighbors between datasets</p>
<p>Non-anchor-based methods: Harmony, which uses soft clustering and iterative correction</p>
<ul>
<li>CCA integration (method=CCAIntegration)</li>
<li>RPCA integration (method=RPCAIntegration)</li>
<li>Joint PCA integration (method=JointPCAIntegration)</li>
<li>Harmony (method=HarmonyIntegration)</li>
</ul>
<section id="canonical-correlation-analysis-cca-integration" class="level3" data-number="2.7.1">
<h3 data-number="2.7.1" class="anchored" data-anchor-id="canonical-correlation-analysis-cca-integration"><span class="header-section-number">2.7.1</span> Canonical Correlation Analysis (CCA) Integration</h3>
<p>CCA (Canonical Correlation Analysis) Integration was the first integration method developed for Seurat. It identifies common sources of variation between datasets by finding linear combinations of features with maximum correlation.</p>
<ul>
<li><p>CCA integration:</p>
<ul>
<li>Performs canonical correlation analysis between pairs of datasets</li>
<li>L2-normalizes the cell embeddings to focus on correlation strength rather than magnitude</li>
<li>Identifies mutual nearest neighbors (anchors) between datasets in the CCA space</li>
<li>Uses these anchors to correct the data and align matching cell populations</li>
</ul></li>
</ul>
<p>By identifying shared sources of variation between datasets, CCA is well-suited for identifying anchors when cell types are conserved, but there are very substantial differences in gene expression across experiments. CCA-based integration therefore enables integrative analysis when experimental conditions or disease states introduce very strong expression shifts, or when integrating datasets across modalities and species. However, CCA-based integration may also lead to overcorrection, especially when a large proportion of cells are non-overlapping across datasets.</p>
</section>
<section id="reciprocal-principal-components-analysis-rpca-integration" class="level3" data-number="2.7.2">
<h3 data-number="2.7.2" class="anchored" data-anchor-id="reciprocal-principal-components-analysis-rpca-integration"><span class="header-section-number">2.7.2</span> Reciprocal Principal Components Analysis (RPCA) Integration</h3>
<p>RPCA (Reciprocal PCA) Integration uses principal component analysis for integration. Unlike CCA, which finds correlations between datasets, RPCA projects each dataset onto the other’s PCA space.</p>
<ul>
<li><p>RPCA integration:</p>
<ul>
<li>Computes PCA on each dataset separately</li>
<li>Projects each dataset onto the other’s PCA space (reciprocal projection)</li>
<li>L2-normalizes the cell embeddings</li>
<li>Identifies mutual nearest neighbors (anchors) between datasets in the projected space</li>
<li>Uses these anchors to correct the data and align matching cell populations</li>
</ul></li>
</ul>
<p>We recommend RPCA during integrative analysis where: A substantial fraction of cells in one dataset have no matching type in the other, datasets that originate from the same platform (i.e.&nbsp;multiple lanes of 10x genomics), or if there are a large number of datasets or cells to integrate.</p>
</section>
<section id="jointpca-integration" class="level3" data-number="2.7.3">
<h3 data-number="2.7.3" class="anchored" data-anchor-id="jointpca-integration"><span class="header-section-number">2.7.3</span> JointPCA Integration</h3>
<p>JointPCA (Joint PCA) Integration first combines all datasets and then performs PCA on the combined data. This method is simpler but can be effective when datasets are already somewhat aligned or have minor batch effects.</p>
<ul>
<li><p>JointPCA integration:</p>
<ul>
<li>Merges the datasets into a single matrix</li>
<li>Performs PCA on the combined data</li>
<li>L2-normalizes the cell embeddings</li>
<li>Identifies mutual nearest neighbors (anchors) between original datasets in the joint PCA space</li>
<li>Uses these anchors to correct the data and align matching cell populations</li>
</ul></li>
</ul>
<p>JointPCA is often faster than CCA or RPCA but may be less effective for datasets with substantial differences or batch effects.</p>
</section>
<section id="harmony-integration" class="level3" data-number="2.7.4">
<h3 data-number="2.7.4" class="anchored" data-anchor-id="harmony-integration"><span class="header-section-number">2.7.4</span> Harmony Integration</h3>
<p>Harmony Integration is a different approach developed by the Korsunsky et al.&nbsp;team (https://doi.org/10.1038/s41592-019-0619-0). Instead of using an anchor-based approach, Harmony uses soft clustering and iterative correction to align datasets.</p>
<ul>
<li><p>Harmony integration:</p>
<ul>
<li>Performs PCA on the combined datasets</li>
<li>Applies soft clustering to group cells by similarity</li>
<li>Iteratively corrects cluster assignments and cell embeddings to align datasets</li>
<li>Uses ridge regression to minimize the effect of dataset-specific variation</li>
</ul></li>
</ul>
<p>Harmony is generally faster than anchor-based methods and often performs well on datasets with complex batch effects.</p>
<p>We will run <code>CCAIntegration</code> (this was the default flavor of integration in previous versions of Seurat), <code>JointPCAIntegration</code>, <code>HarmonyIntegration</code>, and <code>RPCAIntegration</code>. Note that we are specifying that we used <code>SCT</code> normalization:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>start.time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>all_data_sub<span class="ot">&lt;-</span> <span class="fu">IntegrateLayers</span>(</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">object =</span> all_data_sub, <span class="at">method =</span> CCAIntegration,</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">orig.reduction =</span> <span class="st">"pca"</span>, <span class="at">new.reduction =</span> <span class="st">"integrated.cca"</span>, <span class="at">normalization.method =</span> <span class="st">"SCT"</span>,</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>end.time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>end.time <span class="sc">-</span> start.time</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Time difference of 11.29752 secs</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>start.time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>all_data_sub <span class="ot">&lt;-</span> <span class="fu">IntegrateLayers</span>(</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">object =</span> all_data_sub, <span class="at">method =</span> JointPCAIntegration,</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">orig.reduction =</span> <span class="st">"pca"</span>, <span class="at">new.reduction =</span> <span class="st">"integrated.jpca"</span>, <span class="at">normalization.method =</span> <span class="st">"SCT"</span>,</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>end.time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>end.time <span class="sc">-</span> start.time</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Time difference of 8.645848 secs</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>start.time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>all_data_sub <span class="ot">&lt;-</span> <span class="fu">IntegrateLayers</span>(</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">object =</span> all_data_sub, <span class="at">method =</span> HarmonyIntegration,</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">orig.reduction =</span> <span class="st">"pca"</span>, <span class="at">new.reduction =</span> <span class="st">"harmony"</span>, <span class="at">normalization.method =</span> <span class="st">"SCT"</span>,</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>The `features` argument is ignored by `HarmonyIntegration`.
This message is displayed once per session.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>end.time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>end.time <span class="sc">-</span> start.time</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Time difference of 1.208647 secs</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>start.time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>all_data_sub <span class="ot">&lt;-</span> <span class="fu">IntegrateLayers</span>(</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">object =</span> all_data_sub, <span class="at">method =</span> RPCAIntegration,</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">orig.reduction =</span> <span class="st">"pca"</span>, <span class="at">new.reduction =</span> <span class="st">"integrated.rpca"</span>, <span class="at">normalization.method =</span> <span class="st">"SCT"</span>,</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>end.time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>end.time <span class="sc">-</span> start.time</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Time difference of 10.72018 secs</code></pre>
</div>
</div>
</section>
</section>
<section id="clustering" class="level2" data-number="2.8">
<h2 data-number="2.8" class="anchored" data-anchor-id="clustering"><span class="header-section-number">2.8</span> Clustering</h2>
<p>Seurat will cluster your cells into groups of cells with similar expression patterns. The first step is <code>FindNeighbors</code>, which will construct a K-nearest neighbor (KNN) graph based on the euclidean distance in PCA space, and refine the edge weights between any two cells based on the shared overlap in their local neighborhoods (Jaccard similarity). To cluster the cells, we run <code>FindClusters</code> to apply the Louvain algorithm to iteratively group cells together, with the goal of optimizing the standard modularity function. <code>FindClusters</code> takes a <code>resolution</code> argument (defaults to a value of 0.8), which sets the granularity of the clustering, setting this parameter between 0.4-1.2 typically returns good results for single-cell datasets of around 3K cells but the resolution might increase for larger datasets. Use a value above 1 if you want a larger number of communities (clusters), and a value below 1 if you want a smaller number of communities.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>all_data_sub <span class="ot">&lt;-</span> <span class="fu">FindNeighbors</span>(all_data_sub, <span class="at">dims =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">reduction =</span> <span class="st">"pca"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Computing nearest neighbor graph</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Computing SNN</code></pre>
</div>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>all_data_sub <span class="ot">&lt;-</span> <span class="fu">FindClusters</span>(all_data_sub, <span class="at">resolution =</span> .<span class="dv">6</span>, <span class="at">cluster.name =</span> <span class="st">"unintegrated_clusters"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Modularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck

Number of nodes: 1456
Number of edges: 45109

Running Louvain algorithm...
Maximum modularity in 10 random starts: 0.8890
Number of communities: 11
Elapsed time: 0 seconds</code></pre>
</div>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>all_data_sub <span class="ot">&lt;-</span> <span class="fu">FindNeighbors</span>(all_data_sub, <span class="at">reduction =</span> <span class="st">"integrated.cca"</span>, <span class="at">dims =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Computing nearest neighbor graph
Computing SNN</code></pre>
</div>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>all_data_sub <span class="ot">&lt;-</span> <span class="fu">FindClusters</span>(all_data_sub, <span class="at">resolution =</span> .<span class="dv">6</span>, <span class="at">cluster.name =</span> <span class="st">"cca_clusters"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Modularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck

Number of nodes: 1456
Number of edges: 52126

Running Louvain algorithm...
Maximum modularity in 10 random starts: 0.8583
Number of communities: 8
Elapsed time: 0 seconds</code></pre>
</div>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>all_data_sub <span class="ot">&lt;-</span> <span class="fu">FindNeighbors</span>(all_data_sub, <span class="at">reduction =</span> <span class="st">"integrated.jpca"</span>, <span class="at">dims =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Computing nearest neighbor graph
Computing SNN</code></pre>
</div>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>all_data_sub <span class="ot">&lt;-</span> <span class="fu">FindClusters</span>(all_data_sub, <span class="at">resolution =</span> .<span class="dv">6</span>, <span class="at">cluster.name =</span> <span class="st">"jpca_clusters"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Modularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck

Number of nodes: 1456
Number of edges: 51813

Running Louvain algorithm...
Maximum modularity in 10 random starts: 0.8688
Number of communities: 8
Elapsed time: 0 seconds</code></pre>
</div>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>all_data_sub <span class="ot">&lt;-</span> <span class="fu">FindNeighbors</span>(all_data_sub, <span class="at">reduction =</span> <span class="st">"harmony"</span>, <span class="at">dims =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Computing nearest neighbor graph
Computing SNN</code></pre>
</div>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>all_data_sub <span class="ot">&lt;-</span> <span class="fu">FindClusters</span>(all_data_sub, <span class="at">resolution =</span> .<span class="dv">6</span>, <span class="at">cluster.name =</span> <span class="st">"harmony_clusters"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Modularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck

Number of nodes: 1456
Number of edges: 50989

Running Louvain algorithm...
Maximum modularity in 10 random starts: 0.8521
Number of communities: 9
Elapsed time: 0 seconds</code></pre>
</div>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>all_data_sub <span class="ot">&lt;-</span> <span class="fu">FindNeighbors</span>(all_data_sub, <span class="at">reduction =</span> <span class="st">"integrated.rpca"</span>, <span class="at">dims =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Computing nearest neighbor graph
Computing SNN</code></pre>
</div>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>all_data_sub <span class="ot">&lt;-</span> <span class="fu">FindClusters</span>(all_data_sub, <span class="at">resolution =</span> .<span class="dv">6</span>, <span class="at">cluster.name =</span> <span class="st">"rpca_clusters"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Modularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck

Number of nodes: 1456
Number of edges: 49294

Running Louvain algorithm...
Maximum modularity in 10 random starts: 0.8475
Number of communities: 8
Elapsed time: 0 seconds</code></pre>
</div>
</div>
<p>Run UMAP (Uniform Manifold Approximation and Projection) dimensional reduction technique on the unintegrated data and the different integration methods:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>all_data_sub <span class="ot">&lt;-</span> <span class="fu">RunUMAP</span>(all_data_sub, <span class="at">reduction =</span> <span class="st">"pca"</span>, <span class="at">dims =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">reduction.name =</span> <span class="st">"umap.unintegrated"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The default method for RunUMAP has changed from calling Python UMAP via reticulate to the R-native UWOT using the cosine metric
To use Python UMAP via reticulate, set umap.method to 'umap-learn' and metric to 'correlation'
This message will be shown once per session</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>13:30:15 UMAP embedding parameters a = 0.9922 b = 1.112</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>13:30:15 Read 1456 rows and found 10 numeric columns</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>13:30:15 Using Annoy for neighbor search, n_neighbors = 30</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>13:30:15 Building Annoy index with metric = cosine, n_trees = 50</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>0%   10   20   30   40   50   60   70   80   90   100%</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[----|----|----|----|----|----|----|----|----|----|</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>**************************************************|
13:30:15 Writing NN index file to temp file /tmp/RtmpXqTft1/file1e66443af80802
13:30:15 Searching Annoy index using 1 thread, search_k = 3000
13:30:16 Annoy recall = 100%
13:30:17 Commencing smooth kNN distance calibration using 1 thread with target n_neighbors = 30
13:30:18 Initializing from normalized Laplacian + noise (using RSpectra)
13:30:18 Commencing optimization for 500 epochs, with 55744 positive edges
13:30:18 Using rng type: pcg
13:30:21 Optimization finished</code></pre>
</div>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>all_data_sub <span class="ot">&lt;-</span> <span class="fu">RunUMAP</span>(all_data_sub, <span class="at">reduction =</span> <span class="st">"integrated.cca"</span>, <span class="at">dims =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">reduction.name =</span> <span class="st">"umap.cca"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>13:30:21 UMAP embedding parameters a = 0.9922 b = 1.112
13:30:21 Read 1456 rows and found 10 numeric columns
13:30:21 Using Annoy for neighbor search, n_neighbors = 30
13:30:21 Building Annoy index with metric = cosine, n_trees = 50
0%   10   20   30   40   50   60   70   80   90   100%
[----|----|----|----|----|----|----|----|----|----|
**************************************************|
13:30:21 Writing NN index file to temp file /tmp/RtmpXqTft1/file1e66445b9bacb2
13:30:21 Searching Annoy index using 1 thread, search_k = 3000
13:30:21 Annoy recall = 100%
13:30:22 Commencing smooth kNN distance calibration using 1 thread with target n_neighbors = 30
13:30:24 Initializing from normalized Laplacian + noise (using RSpectra)
13:30:24 Commencing optimization for 500 epochs, with 58396 positive edges
13:30:24 Using rng type: pcg
13:30:26 Optimization finished</code></pre>
</div>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>all_data_sub <span class="ot">&lt;-</span> <span class="fu">RunUMAP</span>(all_data_sub, <span class="at">reduction =</span> <span class="st">"integrated.jpca"</span>, <span class="at">dims =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">reduction.name =</span> <span class="st">"umap.jpca"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>13:30:26 UMAP embedding parameters a = 0.9922 b = 1.112
13:30:26 Read 1456 rows and found 10 numeric columns
13:30:26 Using Annoy for neighbor search, n_neighbors = 30
13:30:26 Building Annoy index with metric = cosine, n_trees = 50
0%   10   20   30   40   50   60   70   80   90   100%
[----|----|----|----|----|----|----|----|----|----|
**************************************************|
13:30:27 Writing NN index file to temp file /tmp/RtmpXqTft1/file1e66442972fd80
13:30:27 Searching Annoy index using 1 thread, search_k = 3000
13:30:27 Annoy recall = 100%
13:30:28 Commencing smooth kNN distance calibration using 1 thread with target n_neighbors = 30
13:30:30 Initializing from normalized Laplacian + noise (using RSpectra)
13:30:30 Commencing optimization for 500 epochs, with 58918 positive edges
13:30:30 Using rng type: pcg
13:30:32 Optimization finished</code></pre>
</div>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>all_data_sub <span class="ot">&lt;-</span> <span class="fu">RunUMAP</span>(all_data_sub, <span class="at">reduction =</span> <span class="st">"harmony"</span>, <span class="at">dims =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">reduction.name =</span> <span class="st">"umap.harmony"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>13:30:32 UMAP embedding parameters a = 0.9922 b = 1.112
13:30:32 Read 1456 rows and found 10 numeric columns
13:30:32 Using Annoy for neighbor search, n_neighbors = 30
13:30:32 Building Annoy index with metric = cosine, n_trees = 50
0%   10   20   30   40   50   60   70   80   90   100%
[----|----|----|----|----|----|----|----|----|----|
**************************************************|
13:30:32 Writing NN index file to temp file /tmp/RtmpXqTft1/file1e66441abc6662
13:30:32 Searching Annoy index using 1 thread, search_k = 3000
13:30:33 Annoy recall = 100%
13:30:33 Commencing smooth kNN distance calibration using 1 thread with target n_neighbors = 30
13:30:35 Initializing from normalized Laplacian + noise (using RSpectra)
13:30:35 Commencing optimization for 500 epochs, with 57540 positive edges
13:30:35 Using rng type: pcg
13:30:37 Optimization finished</code></pre>
</div>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>all_data_sub <span class="ot">&lt;-</span> <span class="fu">RunUMAP</span>(all_data_sub, <span class="at">reduction =</span> <span class="st">"integrated.rpca"</span>, <span class="at">dims =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">reduction.name =</span> <span class="st">"umap.rpca"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>13:30:38 UMAP embedding parameters a = 0.9922 b = 1.112
13:30:38 Read 1456 rows and found 10 numeric columns
13:30:38 Using Annoy for neighbor search, n_neighbors = 30
13:30:38 Building Annoy index with metric = cosine, n_trees = 50
0%   10   20   30   40   50   60   70   80   90   100%
[----|----|----|----|----|----|----|----|----|----|
**************************************************|
13:30:38 Writing NN index file to temp file /tmp/RtmpXqTft1/file1e664421291c83
13:30:38 Searching Annoy index using 1 thread, search_k = 3000
13:30:38 Annoy recall = 100%
13:30:39 Commencing smooth kNN distance calibration using 1 thread with target n_neighbors = 30
13:30:41 Initializing from normalized Laplacian + noise (using RSpectra)
13:30:41 Commencing optimization for 500 epochs, with 57330 positive edges
13:30:41 Using rng type: pcg
13:30:43 Optimization finished</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">DimPlot</span>(</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>  all_data_sub,</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">reduction =</span> <span class="st">"umap.unintegrated"</span>,</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">group.by =</span> <span class="st">"orig.ident"</span>,  </span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">label.size =</span> <span class="dv">2</span>,</span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">pt.size =</span> .<span class="dv">5</span>,</span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">alpha =</span> .<span class="dv">25</span></span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">DimPlot</span>(</span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>  all_data_sub,</span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">reduction =</span> <span class="st">"umap.cca"</span>,</span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">group.by =</span> <span class="st">"orig.ident"</span>,  </span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">label.size =</span> <span class="dv">2</span>,</span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">pt.size =</span> .<span class="dv">5</span>,</span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">alpha =</span> .<span class="dv">25</span></span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-19"><a href="#cb97-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-20"><a href="#cb97-20" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">DimPlot</span>(</span>
<span id="cb97-21"><a href="#cb97-21" aria-hidden="true" tabindex="-1"></a>  all_data_sub,</span>
<span id="cb97-22"><a href="#cb97-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">reduction =</span> <span class="st">"umap.jpca"</span>,</span>
<span id="cb97-23"><a href="#cb97-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">group.by =</span> <span class="st">"orig.ident"</span>,  </span>
<span id="cb97-24"><a href="#cb97-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">label.size =</span> <span class="dv">2</span>,</span>
<span id="cb97-25"><a href="#cb97-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">pt.size =</span> .<span class="dv">5</span>,</span>
<span id="cb97-26"><a href="#cb97-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">alpha =</span> .<span class="dv">25</span></span>
<span id="cb97-27"><a href="#cb97-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb97-28"><a href="#cb97-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-29"><a href="#cb97-29" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">DimPlot</span>(</span>
<span id="cb97-30"><a href="#cb97-30" aria-hidden="true" tabindex="-1"></a>  all_data_sub,</span>
<span id="cb97-31"><a href="#cb97-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">reduction =</span> <span class="st">"umap.harmony"</span>,</span>
<span id="cb97-32"><a href="#cb97-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">group.by =</span> <span class="st">"orig.ident"</span>,  </span>
<span id="cb97-33"><a href="#cb97-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">label.size =</span> <span class="dv">2</span>,</span>
<span id="cb97-34"><a href="#cb97-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">pt.size =</span> .<span class="dv">5</span>,</span>
<span id="cb97-35"><a href="#cb97-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">alpha =</span> .<span class="dv">25</span></span>
<span id="cb97-36"><a href="#cb97-36" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb97-37"><a href="#cb97-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-38"><a href="#cb97-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-39"><a href="#cb97-39" aria-hidden="true" tabindex="-1"></a>p5 <span class="ot">&lt;-</span> <span class="fu">DimPlot</span>(</span>
<span id="cb97-40"><a href="#cb97-40" aria-hidden="true" tabindex="-1"></a>  all_data_sub,</span>
<span id="cb97-41"><a href="#cb97-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">reduction =</span> <span class="st">"umap.rpca"</span>,</span>
<span id="cb97-42"><a href="#cb97-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">group.by =</span> <span class="st">"orig.ident"</span>,  </span>
<span id="cb97-43"><a href="#cb97-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">label.size =</span> <span class="dv">2</span>,</span>
<span id="cb97-44"><a href="#cb97-44" aria-hidden="true" tabindex="-1"></a>  <span class="at">pt.size =</span> .<span class="dv">5</span>,</span>
<span id="cb97-45"><a href="#cb97-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">alpha =</span> .<span class="dv">25</span></span>
<span id="cb97-46"><a href="#cb97-46" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Patchwork to view the plots together</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a> p1<span class="sc">+</span>p2<span class="sc">+</span>p3<span class="sc">+</span>p4<span class="sc">+</span>p5<span class="sc">+</span><span class="fu">plot_layout</span>(<span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">guides =</span> <span class="st">"collect"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Intro_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Once integrative analysis is complete, you can rejoin the layers - which collapses the individual datasets together and recreates the original counts and data layers. You will need to do this before performing any differential expression analysis. However, you can always re-split the layers in case you would like to re-perform integrative analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>all_data_sub <span class="ot">&lt;-</span> <span class="fu">JoinLayers</span>(all_data_sub, <span class="at">assay =</span><span class="st">'RNA'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can also see how well the pre-populated cell annotations and Seurat clusters agree, with a table where the rpca_clusters are rows and cell annotations are rows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(all_data_sub<span class="sc">$</span>seurat_annotations, all_data_sub<span class="sc">$</span>rpca_clusters)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              
                 0   1   2   3   4   5   6   7
  B              0   0 125   0   0   0   0   0
  B Activated    0   0  28   0   0   0   0   0
  CD14 Mono    294   1   0   0   0   9   0   0
  CD14+ Mono    82   0   0   0   0   3   0   0
  CD16 Mono      2   0   0   0   0  78   0   0
  CD4 Memory T   0 119   0   0   5   0  10   0
  CD4 Naive T    0  37   1   0 121   0  24   0
  CD8 T          0  16   1  74   1   0   2   0
  DC             7   0   1   0   0   0   0  31
  Eryth          1   2   0   0   0   2   0   0
  FCGR3A+ Mono   1   0   0   0   0  21   0   0
  Memory CD4 T   0  66   1   1   1   0  11   0
  Mk             5   5   0   0   3   3   1   0
  Naive CD4 T    0 114   0   1  12   0   4   0
  NK             0   0   0  70   0   0   2   0
  pDC            0   1   6   0   1   0   1   0
  Platelet       1   0   0   0   0   0   0   0
  T activated    0   2   1   1   0   0  43   0</code></pre>
</div>
</div>
<p>We can also compare dimplots with different labels.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(all_data_sub) <span class="ot">&lt;-</span> <span class="st">'seurat_annotations'</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>plot1 <span class="ot">&lt;-</span> <span class="fu">DimPlot</span>(all_data_sub) </span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="fu">LabelClusters</span>(plot1, <span class="at">id =</span> <span class="st">"ident"</span>, <span class="at">box=</span> <span class="cn">TRUE</span>, <span class="at">size =</span> <span class="dv">5</span>, <span class="at">repel =</span> T, <span class="at">fill =</span> <span class="st">'white'</span>, <span class="at">alpha =</span> .<span class="dv">75</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Intro_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(all_data_sub) <span class="ot">&lt;-</span> <span class="st">'rpca_clusters'</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>plot2 <span class="ot">&lt;-</span> <span class="fu">DimPlot</span>(all_data_sub) </span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a><span class="fu">LabelClusters</span>(plot2, <span class="at">id =</span> <span class="st">"ident"</span>, <span class="at">box=</span> <span class="cn">TRUE</span>, <span class="at">size =</span> <span class="dv">5</span>, <span class="at">repel =</span> T, <span class="at">fill =</span> <span class="st">'white'</span>, <span class="at">alpha =</span> .<span class="dv">75</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Intro_files/figure-html/unnamed-chunk-39-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="clustering-resolution-selection" class="level3" data-number="2.8.1">
<h3 data-number="2.8.1" class="anchored" data-anchor-id="clustering-resolution-selection"><span class="header-section-number">2.8.1</span> Clustering resolution selection</h3>
<p>You can use the <code>clustree</code> package to get a sense of how the resolution you select will impact the clustering.</p>
<p>First, try running the clustering across a range of resolutions:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>resolution.range <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="fl">1.2</span>, <span class="at">by =</span> <span class="fl">0.1</span>)</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>tree <span class="ot">&lt;-</span> <span class="fu">FindClusters</span>(all_data_sub, <span class="at">resolution =</span> resolution.range)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then we can look at the clustering tree.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="fu">clustree</span>(tree)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Intro_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The size of the dots indicates how many cells are in each cluster and the color indicates the resolution used. At the top is showing us the clustering results from <code>resolution = 0</code>, and moving down the tree we can see clusters splitting out into smaller sub-clusters as we reach higher resolutions. If you see situations where clusters split and then re-cluster, this might be a sign that you are getting into over-clustering territory.</p>
</section>
</section>
<section id="differential-expression-analysis" class="level2" data-number="2.9">
<h2 data-number="2.9" class="anchored" data-anchor-id="differential-expression-analysis"><span class="header-section-number">2.9</span> Differential Expression Analysis</h2>
<p>The bulk of Seurat’s differential expression features can be accessed through the <code>FindMarkers()</code> or <code>FindAllMarkers()</code> functions. By default, Seurat performs differential expression (DE) testing based on the non-parametric Wilcoxon rank sum test. To test for DE genes between two specific groups of cells, use <code>FindMarkers()</code> and specify the <code>ident.1</code> and <code>ident.2</code> parameters. Use <code>FindAllMarkers()</code> to test each <code>ident</code> to all other idents. If you have a more complex experimental design, Seurat might not be the best choice and you can come visit us at office hours to discuss your options.</p>
<p>Since we normalized using SCTransform, we have to run <code>PrepSCTFindMarkers()</code> first. Given a merged object with multiple SCT models, this function uses minimum of the median UMI (calculated using the raw UMI counts) of individual objects to reverse the individual SCT regression model using minimum of median UMI as the sequencing depth covariate. The counts slot of the SCT assay is replaced with recorrected counts and the data slot is replaced with log1p of recorrected counts. Then set the <code>DefaultAssay</code> to be the RNA assay.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(all_data_sub) <span class="ot">&lt;-</span> <span class="st">"orig.ident"</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>all_data_sub <span class="ot">&lt;-</span> <span class="fu">PrepSCTFindMarkers</span>(all_data_sub)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Found 3 SCT models. Recorrecting SCT counts using minimum median counts: 1636.5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="fu">DefaultAssay</span>(all_data_sub) <span class="ot">&lt;-</span> <span class="st">"RNA"</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>stim_vs_ctrl <span class="ot">&lt;-</span> <span class="fu">FindMarkers</span>(all_data_sub, <span class="at">ident.1 =</span> <span class="st">"IMMUNE_STIM"</span>, <span class="at">ident.2 =</span> <span class="st">"IMMUNE_CTRL"</span>)</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(stim_vs_ctrl <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(p_val_adj <span class="sc">&lt;</span> .<span class="dv">05</span> <span class="sc">&amp;</span> avg_log2FC <span class="sc">&gt;</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              p_val avg_log2FC pct.1 pct.2     p_val_adj
IFIT3 2.304328e-158   56.44791 0.934 0.060 3.445661e-154
ISG15 7.479361e-152  399.60034 0.988 0.322 1.118389e-147
IFIT1 9.416450e-152   53.38548 0.904 0.036 1.408042e-147
ISG20 2.594336e-148   27.87676 0.988 0.410 3.879311e-144
IFI6  1.526537e-141   28.76951 0.942 0.180 2.282630e-137
MX1   8.625130e-138   15.71071 0.894 0.098 1.289716e-133</code></pre>
</div>
</div>
<p>The results data frame has the following columns :</p>
<pre><code>p_val : p-value (unadjusted)
avg_log2FC : log fold-change of the average expression between the two groups. Positive values indicate that the feature is more highly expressed in the first group.
pct.1 : The percentage of cells where the feature is detected in the first group
pct.2 : The percentage of cells where the feature is detected in the second group
p_val_adj : Adjusted p-value, based on Bonferroni correction using all features in the dataset.</code></pre>
<p>If the <code>ident.2</code> argument is omitted, <code>FindMarkers</code> will test for differentially expressed features between the group specified by <code>ident.1</code> and all other cells. Additionally, the parameter <code>only.pos</code> can be set to TRUE to only search for positive markers, i.e.&nbsp;features that are more highly expressed in the ident.1 group.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>stim_vs_all <span class="ot">&lt;-</span> <span class="fu">FindMarkers</span>(all_data_sub, <span class="at">ident.1 =</span> <span class="st">"IMMUNE_STIM"</span>, <span class="at">only.pos =</span> T)</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(stim_vs_all <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(p_val_adj <span class="sc">&lt;</span> .<span class="dv">05</span> <span class="sc">&amp;</span> avg_log2FC <span class="sc">&gt;</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              p_val avg_log2FC pct.1 pct.2     p_val_adj
IFIT3 6.980485e-236   56.59723 0.934 0.084 1.043792e-231
IFIT1 7.150314e-227   54.24998 0.904 0.064 1.069187e-222
ISG20 8.852470e-204   20.15248 0.988 0.428 1.323710e-199
ISG15 8.337627e-203  400.53542 0.988 0.384 1.246725e-198
IFIT2 9.924276e-182   41.32732 0.756 0.043 1.483977e-177
RSAD2 6.594093e-161   56.68649 0.710 0.053 9.860147e-157</code></pre>
</div>
</div>
<p>We can switch idents to find marker genes for the clusters:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(all_data_sub) <span class="ot">&lt;-</span> <span class="st">'rpca_clusters'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Use <code>FindAllMarkers</code> to compare each cluster to all the other clusters. For the sake of speed, we are selecting only positive genes that are expressed in at least 90% of the cells for a given cluster:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>rpca_markers <span class="ot">&lt;-</span> <span class="fu">FindAllMarkers</span>(all_data_sub, <span class="at">min.pct =</span> .<span class="dv">90</span>, <span class="at">only.pos=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster 0</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster 1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster 2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster 3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster 4</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster 5</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster 6</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster 7</code></pre>
</div>
</div>
<p>Look at the marker genes with the biggest fold change per cluster</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>top_cluster_markers <span class="ot">&lt;-</span> </span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>  rpca_markers <span class="sc">%&gt;%</span> </span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cluster) <span class="sc">%&gt;%</span></span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(p_val_adj <span class="sc">&lt;=</span> <span class="fl">0.05</span>) <span class="sc">%&gt;%</span></span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(avg_log2FC <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(pct<span class="fl">.1</span> <span class="sc">&gt;</span> .<span class="dv">9</span>) <span class="sc">%&gt;%</span></span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(<span class="at">n =</span> <span class="dv">2</span>, <span class="at">order_by =</span> <span class="fu">abs</span>(avg_log2FC))</span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a>top_cluster_markers</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 13 × 7
# Groups:   cluster [7]
       p_val avg_log2FC pct.1 pct.2 p_val_adj cluster gene   
       &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt; &lt;fct&gt;   &lt;chr&gt;  
 1 2.03e-162     335.   1     0.921 3.03e-158 0       FTL    
 2 3.85e-140     108.   0.954 0.322 5.76e-136 0       NPC2   
 3 4.47e- 40      51.7  0.983 0.859 6.69e- 36 1       RPS5   
 4 1.09e- 76      44.9  1     0.97  1.62e- 72 1       RPL3   
 5 2.83e-  6      57.8  0.988 0.982 4.23e-  2 2       TPT1   
 6 6.89e- 17      27.9  0.994 0.926 1.03e- 12 2       PTMA   
 7 3.95e-172      62.4  0.946 0.086 5.90e-168 3       NKG7   
 8 4.74e- 17      52.9  1     0.985 7.08e- 13 3       HLA-A  
 9 7.01e- 47       1.09 0.917 0.421 1.05e- 42 4       GIMAP7 
10 5.59e- 15     149.   1     1     8.36e- 11 5       MALAT1 
11 3.89e- 10      49.7  1     0.991 5.82e-  6 5       RPS19  
12 1.13e- 22     234.   1     0.566 1.69e- 18 7       HLA-DRA
13 2.89e- 21     225.   1     0.745 4.32e- 17 7       CD74   </code></pre>
</div>
</div>
<p>Make a <code>FeaturePlot</code> to look at the expression of specific genes. It will plot the <code>data</code> slot from the default assay. We can switch the default assay to SCT first and specify that we want to use the <code>data</code> slot (log1p(counts)):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="fu">DefaultAssay</span>(all_data_sub) <span class="ot">&lt;-</span> <span class="st">"SCT"</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a><span class="fu">FeaturePlot</span>(all_data_sub, <span class="at">features =</span> <span class="fu">c</span>(<span class="st">"CCL3"</span>), <span class="at">reduction =</span> <span class="st">'umap.rpca'</span>, <span class="at">order =</span> T, <span class="at">slot =</span> <span class="st">'data'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Intro_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can also make a heatmap of the cluster markers. Seurat heatmaps use the <code>scale.data</code> slot by default.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="fu">DoHeatmap</span>(<span class="fu">subset</span>(all_data_sub, <span class="at">downsample =</span> <span class="dv">50</span>), <span class="at">features =</span> top_cluster_markers<span class="sc">$</span>gene) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Intro_files/figure-html/unnamed-chunk-48-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can customize Seurat figures the same way you would customize other ggplot2 figures, like using different colors:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="fu">DoHeatmap</span>(<span class="fu">subset</span>(all_data_sub, <span class="at">downsample =</span> <span class="dv">50</span>), <span class="at">features =</span> top_cluster_markers<span class="sc">$</span>gene) <span class="sc">&amp;</span> viridis<span class="sc">::</span><span class="fu">scale_fill_viridis</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Scale for fill is already present.
Adding another scale for fill, which will replace the existing scale.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Intro_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can adjust which legends are shown, like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="fu">DoHeatmap</span>(<span class="fu">subset</span>(all_data_sub, <span class="at">downsample =</span> <span class="dv">50</span>), <span class="at">features =</span> top_cluster_markers<span class="sc">$</span>gene) <span class="sc">&amp;</span> viridis<span class="sc">::</span><span class="fu">scale_fill_viridis</span>() <span class="sc">&amp;</span> ggplot2<span class="sc">::</span><span class="fu">guides</span>(<span class="at">fill=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Scale for fill is already present.
Adding another scale for fill, which will replace the existing scale.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The `&lt;scale&gt;` argument of `guides()` cannot be `FALSE`. Use "none" instead as
of ggplot2 3.3.4.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Intro_files/figure-html/unnamed-chunk-50-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Or like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="fu">DoHeatmap</span>(<span class="fu">subset</span>(all_data_sub, <span class="at">downsample =</span> <span class="dv">50</span>), <span class="at">features =</span> top_cluster_markers<span class="sc">$</span>gene) <span class="sc">&amp;</span> viridis<span class="sc">::</span><span class="fu">scale_fill_viridis</span>() <span class="sc">&amp;</span> ggplot2<span class="sc">::</span><span class="fu">guides</span>(<span class="at">colour=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Scale for fill is already present.
Adding another scale for fill, which will replace the existing scale.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Intro_files/figure-html/unnamed-chunk-51-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Another helpful visualization from Seurat is <code>DotPlot</code>. The size of each dot indicates the percentage of cells expressing the feature and the color is the average expression level. It uses the scale.data slot by default.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="fu">DotPlot</span>(all_data_sub, <span class="at">features =</span> top_cluster_markers<span class="sc">$</span>gene) <span class="sc">+</span> </span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle=</span><span class="dv">90</span>, <span class="at">vjust=</span>.<span class="dv">5</span>, <span class="at">hjust=</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Intro_files/figure-html/unnamed-chunk-52-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can use more custom colors:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="fu">DotPlot</span>(all_data_sub, <span class="at">features =</span> top_cluster_markers<span class="sc">$</span>gene) <span class="sc">&amp;</span> </span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>    viridis<span class="sc">::</span><span class="fu">scale_color_viridis</span>(<span class="at">option =</span> <span class="st">"magma"</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">&amp;</span></span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle=</span><span class="dv">90</span>, <span class="at">vjust=</span>.<span class="dv">5</span>, <span class="at">hjust=</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Scale for colour is already present.
Adding another scale for colour, which will replace the existing scale.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Intro_files/figure-html/unnamed-chunk-53-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="conclusion" class="level2" data-number="2.10">
<h2 data-number="2.10" class="anchored" data-anchor-id="conclusion"><span class="header-section-number">2.10</span> Conclusion</h2>
<p>Thanks for joining! If you have questions, you can stop by our Zoom office hours. For more information, consult the CCV calendar: https://events.brown.edu/ccv/all</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./index.html" class="pagination-link" aria-label="Introduction">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav>
</div> <!-- /content -->




</body></html>